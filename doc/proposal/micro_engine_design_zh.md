# 微引擎（MicroEngine）文档

## 概述

微引擎（MicroEngine）是一个高度可配置的基于规则的匹配引擎，用于根据各种条件（包括IP地址、URL和请求路径）过滤网络请求。它支持复杂规则定义，具有灵活的条件组合和高效的匹配算法。

## 架构

### 核心组件

1. **RuleEngine（规则引擎）**：中央组件，管理规则和IP组，处理规则匹配和评估。
2. **Rule（规则）**：表示安全规则，具有匹配条件和操作（黑名单/白名单）。
3. **Condition System（条件系统）**：灵活的系统，支持简单条件和复杂的组合条件。
4. **Matcher Interface（匹配器接口）**：定义条件匹配的契约，由不同的条件类型实现。

### 条件类型

1. **SimpleCondition（简单条件）**：基本条件，使用各种匹配策略针对特定目标（IP、URL、路径）进行匹配。
2. **CompositeCondition（组合条件）**：复杂条件，使用逻辑运算符（AND/OR）组合多个条件。

## 核心执行流程

### 工作流程

1. **初始化**：
   - 创建新的RuleEngine实例
   - 配置MongoDB连接（如果使用数据库存储）
   - 从MongoDB或JSON加载IP组和规则

2. **规则加载过程**：
   - 加载具有优先级和序列信息的规则
   - 将条件从BSON/JSON解析为条件对象
   - 按优先级（较高值优先）和序列号排序规则

3. **请求匹配流程**：
   - 验证传入请求数据（IP、URL、路径）
   - 按优先级顺序遍历规则
   - 根据请求评估每个规则的条件
   - 根据规则类型（黑名单/白名单）返回匹配结果
   - 默认行为：如果存在白名单规则但都不匹配则阻止，否则允许

4. **条件匹配**：
   - 简单条件：直接匹配目标
   - 组合条件：递归评估嵌套条件与逻辑运算符
   - 短路评估以优化性能（结果确定时提前退出）

### 流程图（版本1）- 业务流程重点

```
                           ┌───────────────────┐
                           │     请求输入       │
                           └─────────┬─────────┘
                                     ▼
┌─────────────────────────────────────────────────────────────┐
│                       规则引擎                               │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │   规则加载      │    │    IP组管理      │                 │
│  │                 │    │                 │                 │
│  │ - 从数据库加载  │    │ - IP集合管理    │                 │
│  │ - 按优先级排序  │    │ - CIDR范围处理  │                 │
│  │                 │    │                 │                 │
│  └────────┬────────┘    └─────────────────┘                 │
│           │                                                 │
│           ▼                                                 │
│  ┌────────────────────────────────────────┐                 │
│  │             规则处理                    │                 │
│  │                                         │                 │
│  │  ┌───────────┐   ┌────────────────┐    │                 │
│  │  │简单规则评估│   │  组合规则评估  │    │                 │
│  │  │           │   │                │    │                 │
│  │  └───────────┘   └────────────────┘    │                 │
│  │                                         │                 │
│  └──────────────────┬─────────────────────┘                 │
│                     │                                       │
│                     ▼                                       │
│  ┌────────────────────────────────────────┐                 │
│  │           决策应用                      │                 │
│  │                                         │                 │
│  │  ┌────────────┐    ┌────────────┐      │                 │
│  │  │ 黑名单操作 │    │ 白名单操作 │      │                 │
│  │  │           │    │            │      │                 │
│  │  └────────────┘    └────────────┘      │                 │
│  │                                         │                 │
│  └──────────────────┬─────────────────────┘                 │
│                     │                                       │
└─────────────────────┼───────────────────────────────────────┘
                      ▼
             ┌─────────────────┐
             │  允许/阻止决策   │
             │                 │
             └─────────────────┘
```

### 流程图（版本2）- 实现细节重点

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                            初始化过程                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  NewRuleEngine() → RuleEngine{                                                │
│     Rules: make([]Rule, 0),                                                   │
│     IPGroups: make(map[string]*model.IPGroup),                                │
│     regexCache: make(map[string]*regexp.Regexp),                              │
│  }                                                                            │
│                                                                               │
│  InitMongoConfig(config *MongoDBConfig) → 设置 e.mongoConfig                   │
│                                                                               │
│  LoadAllFromMongoDB() → {                                                     │
│     LoadIPGroupsFromMongoDB()                                                 │
│     LoadRulesFromMongoDB()                                                    │
│  }                                                                            │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                          规则加载与解析                                        │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  LoadRulesFromMongoDB() → {                                                   │
│     1. 获取规则集合                                                            │
│     2. 检查/创建默认规则（如需要）                                              │
│     3. 查询所有规则: cursor, err := collection.Find(ctx, bson.D{})             │
│     4. 解析规则: cursor.All(ctx, &rules)                                       │
│     5. 设置序列号: rules[i].sequence = i                                       │
│     6. 解析条件:                                                               │
│        for i := range rules {                                                 │
│          parsedCondition, err := e.factory.ParseCondition(rule.Condition)     │
│          rule.parsedCondition = parsedCondition                               │
│        }                                                                      │
│     7. 按优先级和序列号排序                                                     │
│  }                                                                            │
│                                                                               │
│  ParseCondition(data bson.Raw) → Matcher {                                    │
│     1. 解析条件类型                                                            │
│     2. 如果是SimpleConditionType:                                              │
│        - 返回SimpleCondition                                                   │
│     3. 如果是CompositeConditionType:                                           │
│        - 递归解析所有嵌套条件                                                   │
│        - 存储在condition.parsedConditions中                                    │
│  }                                                                            │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                           请求匹配处理                                         │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  MatchRequest(ip, url, path) → (bool, model.RuleType, *Rule, error) {         │
│     1. 验证IP: if !isValidIP(ip) { return error }                              │
│     2. 检查白名单: hasWhitelistRule = 任何规则是白名单                           │
│     3. 遍历规则（已排序）:                                                      │
│        - 跳过禁用规则: if r.Status == model.RuleDisabled { continue }          │
│        - 测试规则: match, err := r.parsedCondition.Match(e, ip, url, path)     │
│        - 如果匹配黑名单: return true（阻止）, r.Type, &r, nil                    │
│        - 如果匹配白名单: return false（允许）, r.Type, &r, nil                   │
│     4. 默认行为:                                                               │
│        - 如果存在白名单但没有匹配: return true（阻止）                            │
│        - 否则: return false（允许）                                             │
│  }                                                                            │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                           条件匹配处理                                         │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  SimpleCondition.Match(eng, ip, url, path) → (bool, error) {                  │
│     - 根据Target:                                                              │
│       - SourceIP: return eng.matchIP(c, ip)                                   │
│       - TargetURL: return eng.matchURL(c, url)                                │
│       - TargetPath: return eng.matchPath(c, path)                             │
│  }                                                                            │
│                                                                               │
│  matchIP/matchURL/matchPath方法应用特定匹配器:                                  │
│     - MatchEqual: 直接比较                                                     │
│     - MatchInIPGroup: 检查组中所有IP                                           │
│     - MatchRegex: 使用缓存的正则表达式                                          │
│     - 等等                                                                     │
│                                                                               │
│  CompositeCondition.Match(eng, ip, url, path) → (bool, error) {               │
│     1. 基于运算符设置默认结果:                                                   │
│        - AND: result = true                                                   │
│        - OR: result = false                                                   │
│     2. 遍历嵌套条件:                                                           │
│        - 递归调用每个条件的Match()                                              │
│        - 应用短路逻辑:                                                         │
│          - AND: if !match return false（短路）                                 │
│          - OR: if match return true（短路）                                    │
│     3. 返回最终结果                                                            │
│  }                                                                            │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## 组合条件中的递归流程

组合条件评估使用递归来处理嵌套条件：

1. `ParseCondition`方法递归解析组合条件中的嵌套条件
2. 匹配过程中，`CompositeCondition.Match()`递归调用所有子条件的`Match()`方法
3. 应用逻辑运算（AND/OR）并进行短路评估：
   - 对于AND：当任何条件失败时返回false
   - 对于OR：当任何条件成功时返回true

### 条件工厂与递归解析流程图

规则工厂通过递归解析实现了任意条件组合。这是一个关键特性，它允许创建具有无限嵌套的复杂规则层次结构。

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                       条件工厂与解析流程                                        │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ParseCondition(data bson.Raw)                                                │
│  ┌─────────────────────────────┐                                              │
│  │ 提取基础条件类型            │                                              │
│  └──────────────┬──────────────┘                                              │
│                 │                                                             │
│                 ▼                                                             │
│  ┌─────────────────────────────┐                                              │
│  │ 根据条件类型进行分支处理    │                                              │
│  └──────────────┬──────────────┘                                              │
│                 │                                                             │
│        ┌────────┴────────┐                                                    │
│        │                 │                                                    │
│        ▼                 ▼                                                    │
│  ┌────────────┐   ┌────────────────────────────┐                              │
│  │ 简单条件   │   │ 组合条件                   │                              │
│  │ (Simple)   │   │ (Composite)                │                              │
│  └─────┬──────┘   └─────────────┬──────────────┘                              │
│        │                        │                                             │
│        │                        ▼                                             │
│        │          ┌────────────────────────────┐                              │
│        │          │ 初始化空数组               │                              │
│        │          │ condition.parsedConditions │                              │
│        │          └─────────────┬──────────────┘                              │
│        │                        │                                             │
│        │                        ▼                                             │
│        │          ┌────────────────────────────┐                              │
│        │          │ 遍历每个子条件             │◄─────┐                       │
│        │          └─────────────┬──────────────┘      │                       │
│        │                        │                     │                       │
│        │                        ▼                     │                       │
│        │          ┌────────────────────────────┐      │                       │
│        │          │ 递归调用:                  │      │                       │
│        │          │ ParseCondition(childData)  │      │                       │
│        │          └─────────────┬──────────────┘      │                       │
│        │                        │                     │                       │
│        │                        ▼                     │                       │
│        │          ┌────────────────────────────┐      │                       │
│        │          │ 将子条件添加到             │      │                       │
│        │          │ parsedConditions数组       │──────┘                       │
│        │          └────────────────────────────┘                              │
│        │                                                                      │
│        └───────────────┐ ┌───────────────────────                             │
│                        │ │                                                    │
│                        ▼ ▼                                                    │
│               ┌────────────────────┐                                          │
│               │ 返回实现Matcher接口│                                          │
│               │ 的条件对象         │                                          │
│               └────────────────────┘                                          │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 条件评估与树形遍历流程图

在根据规则评估请求时，条件树会被递归遍历：

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                         条件评估（树形遍历）                                    │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  规则评估过程                                                                  │
│  ┌──────────────────────────┐                                                 │
│  │ rule.parsedCondition.Match(engine, ip, url, path)                          │
│  └────────────────┬─────────┘                                                 │
│                   │                                                           │
│                   ▼                                                           │
│  ┌─────────────────────────────┐                                              │
│  │ 是否为简单条件？            │                                              │
│  └────────────┬────────────────┘                                              │
│               │                                                               │
│      ┌────────┴─────────┐                                                     │
│      │                  │                                                     │
│      ▼                  ▼                                                     │
│  ┌────────────┐  ┌─────────────────┐                                          │
│  │ 简单条件   │  │ 组合条件        │                                          │
│  │ 匹配处理   │  │ 匹配处理        │                                          │
│  └─────┬──────┘  └────────┬────────┘                                          │
│        │                  │                                                   │
│        ▼                  ▼                                                   │
│  ┌────────────┐  ┌─────────────────────────┐                                  │
│  │ 根据目标类型│  │ 基于运算符初始化结果    │                                  │
│  │ 进行匹配:   │  │ (AND/OR)               │                                  │
│  │ - IP        │  └────────────┬────────────┘                                 │
│  │ - URL       │               │                                              │
│  │ - Path      │               ▼                                              │
│  └─────┬──────┘  ┌─────────────────────────┐                                  │
│        │         │ 遍历每个子条件          │◄────┐                            │
│        │         └────────────┬────────────┘     │                            │
│        │                      │                  │                            │
│        │                      ▼                  │                            │
│        │         ┌─────────────────────────┐     │                            │
│        │         │ 递归调用:               │     │                            │
│        │         │ condition.Match()       │     │                            │
│        │         └────────────┬────────────┘     │                            │
│        │                      │                  │                            │
│        │                      ▼                  │                            │
│        │         ┌─────────────────────────┐     │                            │
│        │         │ 应用短路逻辑:           │     │                            │
│        │         │ - AND: 若!match则立即   │     │                            │
│        │         │   返回false             │     │                            │
│        │         │ - OR: 若match则立即     │     │                            │
│        │         │   返回true              │     │                            │
│        │         └────────────┬────────────┘     │                            │
│        │                      │                  │                            │
│        │                      │                  │                            │
│        │                      │ (如无短路)        │                            │
│        │                      ▼                  │                            │
│        │         ┌─────────────────────────┐     │                            │
│        │         │ 继续处理下一个子条件    │─────┘                            │
│        │         └─────────────────────────┘                                  │
│        │                                                                      │
│        └───────────────┐ ┌───────────────────────                             │
│                        │ │                                                    │
│                        ▼ ▼                                                    │
│               ┌────────────────────┐                                          │
│               │ 返回最终匹配结果   │                                          │
│               │ (bool值)           │                                          │
│               └────────────────────┘                                          │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

这种递归结构可以实现任意深度和复杂度的条件树，例如：

```
                         根条件 (AND)
                        /                  \
                       /                    \
              简单条件                  组合条件 (OR)
            (IP在黑名单中)              /                \
                                      /                  \
                          简单条件                 组合条件 (AND)
                       (URL包含"/admin")          /               \
                                               /                   \
                                     简单条件                简单条件
                                  (路径以"/api"开头)      (URL包含".php")
```

## 设计原则

1. **灵活性**：支持各种匹配策略和复杂的条件组合
2. **性能优化**：
   - 正则表达式缓存
   - 逻辑运算符的短路评估
   - 基于优先级的规则处理，优化常见情况
   - 高效的IP匹配算法（IP组，CIDR匹配）

3. **可扩展性**：
   - 基于接口的设计允许添加新的条件类型
   - 用于条件创建的工厂模式
   - 规则存储和规则评估之间的明确分离

4. **弹性**：
   - 全面的错误处理
   - 输入验证（IP地址，CIDR范围，正则表达式模式）
   - 系统保护的默认规则

## 性能考虑

1. **RegEx缓存**：引擎维护已编译正则表达式的缓存，避免重复编译
2. **规则优先级**：规则按优先级排序，确保先检查重要规则
3. **短路评估**：一旦确定结果，逻辑运算就会停止
4. **CIDR优化**：高效匹配IP地址与CIDR范围
5. **未来优化**（代码中的TODO）：
   - 用基数树（Radix Tree/Patricia Trie）替换IP组的线性扫描
   - 为正则表达式实现LRU缓存
   - 为缓存项添加过期时间，防止缓存增长

## 维护指南

1. **添加新的匹配类型**：
   - 在适当的MatchType枚举中添加新常量
   - 在相应的匹配函数中实现匹配逻辑
   - 更新相关条件类型中的验证

2. **添加新的目标类型**：
   - 在TargetType枚举中添加新常量
   - 在SimpleCondition的Match方法中添加案例处理
   - 在RuleEngine中实现新的匹配函数

3. **性能调优**：
   - 监控和优化regexCache大小
   - 审查规则优先级分配，获得最佳处理顺序
   - 考虑实现代码中标记的TODO，以进行额外优化 